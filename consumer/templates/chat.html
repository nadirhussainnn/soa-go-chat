<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ChatApp</title>
    <link rel="stylesheet" href="/static/chat.css">
</head>
<body>
    <div class="chat-container">
        <!-- Chat Header -->
        <header class="chat-header">
            <div class="profile-pic"></div>
            <div class="username">John Doe</div>
        </header>

        <!-- Chat Messages -->
        <main class="chat-messages" id="chat-messages">
            <!-- Messages will be dynamically added here -->
        </main>

        <!-- Chat Input -->
        <footer class="chat-input">
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Type a message" required>
                <label for="attachment">
                    <input type="file" id="attachment" style="display: none;">
                    ðŸ“Ž
                </label>
                <button type="submit">Send</button>
            </form>
        </footer>
    </div>

    <script src="/static/helpers.js"></script>
    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        const userId = "{{ . }}";


        // WebSocket connection for messaging-service
        const ws = new WebSocket(`ws://localhost:8080/ws/messages?user_id=${userId}`);
    
        ws.onopen = () => {
            console.log("WebSocket connection established for messaging-service.");
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("WebSocket message received:", data);

            if (data.type === SOCKET_EVENTS.NEW_MESSAGE_RECEIVED) {
                // Handle received message
                const time = new Date().toLocaleTimeString();
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble', 'received');
                messageBubble.innerHTML = `
                    <p>${data.content}</p>
                    <span class="message-time">${time}</span>
                `;
                chatMessages.appendChild(messageBubble);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
            }
        };

        ws.onclose = () => {
            console.log("WebSocket connection closed.");
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        // Handle sending messages
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const content = messageInput.value.trim();
            if (content) {
                const payload = {
                    type: "send_message",
                    user_id: userId,
                    content: content,
                    timestamp: new Date().toISOString(),
                };

                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(payload)); // Send the message to the server
                    console.log("Message sent:", payload);

                    const time = new Date().toLocaleTimeString();
                    const messageBubble = document.createElement('div');
                    messageBubble.classList.add('message-bubble', 'sent');
                    messageBubble.innerHTML = `
                        <p>${content}</p>
                        <span class="message-time">${time}</span>
                    `;
                    chatMessages.appendChild(messageBubble);
                    chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
                    messageInput.value = ''; // Clear input field
                } else {
                    console.error("WebSocket connection is not open.");
                    showSnackbar("Failed to send message. WebSocket not connected.", "error");
                }
            }
        });

    </script>
</body>
</html>
